<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Indoor Navigation Map</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
        }
        #map-container {
            margin-top: 20px;
        }
        select {
            font-size: 16px;
            padding: 5px;
            margin-top: 10px;
        }
        #qrCodes {
            margin-top: 30px;
            display: flex;
            flex-wrap: wrap; /* Allow the QR codes to wrap to the next line */
            gap: 20px; /* Add space between the QR codes */
        }
        .qrCodeContainer {
            text-align: center; /* Center align the QR code and its label */
            margin-right: 20px; /* Add space to the right of each QR code */
        }
        #dropdown-container {
            display: none; /* Initially hide the dropdown */
        }
    </style>
</head>
<body>
    <h1>Indoor Navigation Map with QR Codes</h1>

    <!-- QR Code Display for Rooms -->
    <div id="qrCodes">
        <h2>QR Codes for Starting Locations:</h2>
        <div class="qrCodeContainer">
            <div id="qr-room101"></div>
            <p>Room 101</p>
        </div>
        <div class="qrCodeContainer">
            <div id="qr-room102"></div>
            <p>Room 102</p>
        </div>
        <div class="qrCodeContainer">
            <div id="qr-room201"></div>
            <p>Room 201</p>
        </div>
        <div class="qrCodeContainer">
            <div id="qr-room202"></div>
            <p>Room 202</p>
        </div>
        <div class="qrCodeContainer">
            <div id="qr-room301"></div>
            <p>Room 301</p>
        </div>
        <div class="qrCodeContainer">
            <div id="qr-room302"></div>
            <p>Room 302</p>
        </div>
        <div class="qrCodeContainer">
            <div id="qr-room401"></div>
            <p>Room 401</p>
        </div>
        <div class="qrCodeContainer">
            <div id="qr-room402"></div>
            <p>Room 402</p>
        </div>
    </div>

    <!-- Dropdown for Destination -->
    <div id="dropdown-container">
        <h2>Select Destination:</h2>
        <select id="destination">
            <option value="none">Select a Room</option>
            <option value="room101">Room 101</option>
            <option value="room102">Room 102</option>
            <option value="room201">Room 201</option>
            <option value="room202">Room 202</option>
            <option value="room301">Room 301</option>
            <option value="room302">Room 302</option>
            <option value="room401">Room 401</option>
            <option value="room402">Room 402</option>
        </select>
    </div>

    <!-- Canvas for the Map -->
    <div id="map-container">
        <h2>Map:</h2>
        <div id="map"></div>
    </div>

    <script>
        // Room positions
        let roomPositions = {
            room101: { x: 100, y: 100 },
            room102: { x: 300, y: 100 },
            room201: { x: 100, y: 300 },
            room202: { x: 300, y: 300 },
            room301: { x: 100, y: 200 }, // New Room 301
            room302: { x: 300, y: 200 }, // New Room 302
            room401: { x: 100, y: 400 }, // New Room 401
            room402: { x: 300, y: 400 }  // New Room 402
        };

        // Graph representation of rooms
        const graph = {
            room101: ['room102', 'room201', 'room301'],
            room102: ['room101', 'room202', 'room302'],
            room201: ['room101', 'room202', 'room401'],
            room202: ['room102', 'room201', 'room402'],
            room301: ['room101', 'room302'],
            room302: ['room102', 'room301', 'room402'],
            room401: ['room201'],
            room402: ['room202']
        };

        let startRoom = null;
        let destinationRoom = null;

        function setup() {
            const canvas = createCanvas(400, 500);
            canvas.parent('map');
            textSize(16);

            // Get current location from URL (scanned QR code)
            const urlParams = new URLSearchParams(window.location.search);
            const currentLocation = urlParams.get('location');
            if (currentLocation) {
                startRoom = currentLocation;
                // Show the dropdown when QR code is scanned
                document.getElementById('dropdown-container').style.display = 'block';
            }

            noLoop(); // Only redraw when necessary
        }

        function draw() {
            background(255);

            // Draw and label rooms
            for (let room in roomPositions) {
                let pos = roomPositions[room];

                // Highlight the starting room in green
                if (room === startRoom) {
                    fill(0, 255, 0);
                } 
                // Highlight the destination room in red
                else if (room === destinationRoom) {
                    fill(255, 0, 0);
                } else {
                    fill(200);
                }

                ellipse(pos.x, pos.y, 50, 50); // Draw room as a circle
                fill(0);
                textAlign(CENTER);
                text(room, pos.x, pos.y + 5); // Label the room
            }

            // Draw path between start and destination if both are selected
            if (startRoom && destinationRoom) {
                const path = findShortestPath(startRoom, destinationRoom);
                if (path.length > 0) {
                    stroke(0, 0, 255);
                    strokeWeight(3);
                    for (let i = 0; i < path.length - 1; i++) {
                        let startPos = roomPositions[path[i]];
                        let endPos = roomPositions[path[i + 1]];
                        line(startPos.x, startPos.y, endPos.x, endPos.y); // Draw the line
                    }
                }
            }
        }

        // Handle dropdown selection for destination
        document.getElementById('destination').addEventListener('change', function() {
            const selectedRoom = this.value;
            if (selectedRoom !== 'none') {
                destinationRoom = selectedRoom;
                redraw();  // Redraw the map with the new destination
            }
        });

        // Function to find the shortest path using BFS
        function findShortestPath(start, destination) {
            let queue = [[start]];
            let visited = new Set();

            while (queue.length > 0) {
                let path = queue.shift();
                let room = path[path.length - 1];

                if (room === destination) {
                    return path; // Return the path if destination is found
                }

                if (!visited.has(room)) {
                    visited.add(room);
                    for (let neighbor of graph[room]) {
                        queue.push([...path, neighbor]); // Add new paths to the queue
                    }
                }
            }

            return []; // Return empty if no path found
        }

        // Generate QR codes for each room
        function generateQRCode(elementId, room) {
            const qrCodeData = `https://ks-nath.github.io/indoor-mapping?location=${room}`;
            new QRCode(document.getElementById(elementId), {
                text: qrCodeData,
                width: 128,
                height: 128
            });
        }

        // Generate QR codes for the rooms
        generateQRCode('qr-room101', 'room101');
        generateQRCode('qr-room102', 'room102');
        generateQRCode('qr-room201', 'room201');
        generateQRCode('qr-room202', 'room202');
        generateQRCode('qr-room301', 'room301');
        generateQRCode('qr-room302', 'room302');
        generateQRCode('qr-room401', 'room401');
        generateQRCode('qr-room402', 'room402');
    </script>
</body>
</html>
